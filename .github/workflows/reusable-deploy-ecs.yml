name: Reusable ECS Deploy

on:
  workflow_call:
    inputs:
      # ========== OBRIGATÓRIOS ==========
      image_uri:
        description: 'URI completa da imagem Docker (registry/repo:tag)'
        required: true
        type: string
      ecs_service:
        description: 'Nome do service ECS e da task definition family'
        required: true
        type: string
      environment:
        description: 'Ambiente (dev|qa|sbx|prd)'
        required: true
        type: string
      service_type:
        description: 'Tipo de serviço: api ou worker'
        required: false
        type: string
        default: 'worker'
        
      # ========== ECS CLUSTER ==========
      ecs_cluster:
        description: 'Nome do cluster ECS'
        required: false
        type: string
        default: ''
      aws_region:
        description: 'Região AWS'
        required: false
        type: string
        default: 'us-east-1'
        
      # ========== TASK DEFINITION ==========
      ecs_task_execution_role_arn:
        description: 'ARN da role de execução da task'
        required: false
        type: string
        default: ''
      ecs_task_role_arn:
        description: 'ARN da role da task'
        required: false
        type: string
        default: ''
      task_cpu:
        description: 'CPU para Fargate (256, 512, 1024, 2048, 4096)'
        required: false
        type: string
        default: '256'
      task_memory:
        description: 'Memória em MB para Fargate'
        required: false
        type: string
        default: '512'
      container_name:
        description: 'Nome do container na task definition'
        required: false
        type: string
        default: 'app'
      container_port:
        description: 'Porta do container'
        required: false
        type: string
        default: '80'
      container_environment:
        description: 'JSON array de variáveis de ambiente'
        required: false
        type: string
        default: ''
      container_secrets:
        description: 'JSON array de secrets'
        required: false
        type: string
        default: ''
      runtime_cpu_architecture:
        description: 'CPU da plataforma (X86_64, ARM64)'
        required: false
        type: string
        default: ''
      runtime_os_family:
        description: 'OS da plataforma (LINUX, WINDOWS_SERVER_2019_CORE)'
        required: false
        type: string
        default: ''
      awslogs_mode:
        description: 'Modo awslogs (non-blocking ou blocking)'
        required: false
        type: string
        default: ''
      awslogs_create_group:
        description: 'Criar log group se não existir'
        required: false
        type: string
        default: ''
      awslogs_max_buffer_size:
        description: 'Tamanho máximo do buffer'
        required: false
        type: string
        default: ''
      port_mapping_app_protocol:
        description: 'appProtocol do portMapping'
        required: false
        type: string
        default: ''
        
      # ========== SERVICE CONFIG ==========
      subnet_ids:
        description: 'IDs das subnets separados por vírgula'
        required: false
        type: string
        default: ''
      security_group_ids:
        description: 'IDs dos security groups separados por vírgula'
        required: false
        type: string
        default: ''
      assign_public_ip:
        description: 'Atribuir IP público (ENABLED/DISABLED)'
        required: false
        type: string
        default: 'DISABLED'
      desired_count:
        description: 'Número desejado de tasks'
        required: false
        type: string
        default: '1'
      enable_zone_rebalancing:
        description: 'Ativar rebalanceamento de zonas'
        required: false
        type: boolean
        default: false
      health_check_grace_period_seconds:
        description: 'Período de carência do health check'
        required: false
        type: string
        default: ''
      deployment_circuit_breaker_enable:
        description: 'Habilitar disjuntor de implantação'
        required: false
        type: boolean
        default: false
      deployment_circuit_breaker_rollback:
        description: 'Rollback automático quando disjuntor disparar'
        required: false
        type: boolean
        default: false
      capacity_provider_strategy:
        description: 'Estratégia de capacity providers'
        required: false
        type: string
        default: ''
      platform_version:
        description: 'Versão da plataforma Fargate'
        required: false
        type: string
        default: ''
      enable_execute_command:
        description: 'Ativar ECS Exec'
        required: false
        type: boolean
        default: false
      deployment_minimum_healthy_percent:
        description: 'Mínimo % de tarefas saudáveis'
        required: false
        type: string
        default: ''
      deployment_maximum_percent:
        description: 'Máximo % de tarefas durante deploy'
        required: false
        type: string
        default: ''
        
      # ========== LOAD BALANCER (API only) ==========
      create_target_group_and_listener:
        description: 'Para API: obter ou criar target group e listener'
        required: false
        type: boolean
        default: false
      load_balancer_arn:
        description: 'ARN do ALB'
        required: false
        type: string
        default: ''
      load_balancer_name:
        description: 'Nome do ALB existente'
        required: false
        type: string
        default: ''
      listener_port:
        description: 'Porta do listener'
        required: false
        type: string
        default: '80'
      target_group_name:
        description: 'Nome do target group'
        required: false
        type: string
        default: ''
      target_group_port:
        description: 'Porta do target group'
        required: false
        type: string
        default: '80'
      target_group_protocol:
        description: 'Protocolo do target group'
        required: false
        type: string
        default: 'HTTP'
      target_group_health_check_path:
        description: 'Caminho do health check'
        required: false
        type: string
        default: '/'
      target_group_health_check_protocol:
        description: 'Protocolo do health check'
        required: false
        type: string
        default: 'HTTP'
      target_group_deregistration_delay_seconds:
        description: 'Deregistration delay em segundos'
        required: false
        type: string
        default: '300'
      listener_rule_path_pattern:
        description: 'Path pattern para regra do listener'
        required: false
        type: string
        default: ''
      listener_rule_host_header:
        description: 'Host header para regra do listener'
        required: false
        type: string
        default: ''
      listener_rule_priority:
        description: 'Prioridade da regra do listener'
        required: false
        type: string
        default: ''
        
      # ========== HEALTH CHECK PÓS-DEPLOY ==========
      enable_health_check:
        description: 'Executar health check HTTP pós-deploy'
        required: false
        type: boolean
        default: false
      health_check_url:
        description: 'URL do health check'
        required: false
        type: string
        default: ''

      # ========== ACTIONS CONFIG ==========
      actions_repo:
        description: 'Repositório que contém as actions reutilizáveis'
        required: false
        type: string
        default: 'iannkzw/infra-ci-cd'
      actions_ref:
        description: 'Branch/tag do repositório de actions'
        required: false
        type: string
        default: 'refactor-ci-cd'
        
    secrets:
      AWS_ACCESS_KEY_ID:
        required: true
      AWS_SECRET_ACCESS_KEY:
        required: true
      ECS_CLUSTER:
        required: false
      ECS_TASK_EXECUTION_ROLE_ARN:
        required: false
        
    outputs:
      service_arn:
        description: 'ARN do service ECS'
        value: ${{ jobs.deploy.outputs.service_arn }}
      task_definition_arn:
        description: 'ARN da task definition registrada'
        value: ${{ jobs.deploy.outputs.task_definition_arn }}
      target_group_arn:
        description: 'ARN do target group (se API)'
        value: ${{ jobs.deploy.outputs.target_group_arn }}

jobs:
  deploy:
    name: Deploy to ECS
    runs-on: ubuntu-latest
    environment: ${{ inputs.environment }}
    outputs:
      service_arn: ${{ steps.ecs-deploy.outputs.service_arn }}
      task_definition_arn: ${{ steps.task-def.outputs.task_definition_arn }}
      target_group_arn: ${{ steps.alb-setup.outputs.target_group_arn }}

    steps:
      - name: Validar inputs
        id: validate
        run: |
          ENV="${{ inputs.environment }}"
          case "$ENV" in dev|qa|sbx|prd) echo "✅ Ambiente: $ENV" ;; *) echo "❌ Ambiente inválido"; exit 1 ;; esac
          [ -z "${{ inputs.ecs_service }}" ] && echo "❌ ecs_service obrigatório" && exit 1
          [ -z "${{ inputs.image_uri }}" ] && echo "❌ image_uri obrigatório" && exit 1
          echo "ecs_service=${{ inputs.ecs_service }}" >> $GITHUB_OUTPUT

      - name: Checkout (para actions locais)
        uses: actions/checkout@v4
        with:
          repository: ${{ inputs.actions_repo }}
          ref: ${{ inputs.actions_ref }}
          path: .ci-actions

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ inputs.aws_region }}

      # ========== TASK DEFINITION ==========
      - name: Register Task Definition
        id: task-def
        uses: ./.ci-actions/.github/actions/ecs-register-task-def
        with:
          ecs_cluster: ${{ inputs.ecs_cluster || secrets.ECS_CLUSTER }}
          ecs_service: ${{ inputs.ecs_service }}
          image_uri: ${{ inputs.image_uri }}
          task_execution_role_arn: ${{ inputs.ecs_task_execution_role_arn || secrets.ECS_TASK_EXECUTION_ROLE_ARN }}
          task_role_arn: ${{ inputs.ecs_task_role_arn }}
          task_cpu: ${{ inputs.task_cpu }}
          task_memory: ${{ inputs.task_memory }}
          container_name: ${{ inputs.container_name }}
          container_port: ${{ inputs.container_port }}
          container_environment: ${{ inputs.container_environment }}
          container_secrets: ${{ inputs.container_secrets }}
          aws_region: ${{ inputs.aws_region }}
          runtime_cpu_architecture: ${{ inputs.runtime_cpu_architecture }}
          runtime_os_family: ${{ inputs.runtime_os_family }}
          awslogs_mode: ${{ inputs.awslogs_mode }}
          awslogs_create_group: ${{ inputs.awslogs_create_group }}
          awslogs_max_buffer_size: ${{ inputs.awslogs_max_buffer_size }}
          port_mapping_app_protocol: ${{ inputs.port_mapping_app_protocol }}

      # ========== TARGET GROUP (API only) ==========
      - name: Setup ALB Target Group
        id: alb-setup
        if: inputs.service_type == 'api' && inputs.create_target_group_and_listener
        uses: ./.ci-actions/.github/actions/alb-target-group
        with:
          load_balancer_arn: ${{ inputs.load_balancer_arn }}
          load_balancer_name: ${{ inputs.load_balancer_name }}
          subnet_ids: ${{ inputs.subnet_ids }}
          target_group_name: ${{ inputs.target_group_name }}
          target_group_port: ${{ inputs.target_group_port }}
          target_group_protocol: ${{ inputs.target_group_protocol }}
          health_check_path: ${{ inputs.target_group_health_check_path }}
          health_check_protocol: ${{ inputs.target_group_health_check_protocol }}
          deregistration_delay_seconds: ${{ inputs.target_group_deregistration_delay_seconds }}
          listener_port: ${{ inputs.listener_port }}
          listener_rule_path_pattern: ${{ inputs.listener_rule_path_pattern }}
          listener_rule_host_header: ${{ inputs.listener_rule_host_header }}
          listener_rule_priority: ${{ inputs.listener_rule_priority }}
          service_name: ${{ inputs.ecs_service }}

      # ========== DEPLOY SERVICE ==========
      - name: Deploy ECS Service
        id: ecs-deploy
        uses: ./.ci-actions/.github/actions/ecs-deploy-service
        with:
          ecs_cluster: ${{ inputs.ecs_cluster || secrets.ECS_CLUSTER }}
          ecs_service: ${{ inputs.ecs_service }}
          task_definition_arn: ${{ steps.task-def.outputs.task_definition_arn }}
          service_exists: ${{ steps.task-def.outputs.service_exists }}
          service_type: ${{ inputs.service_type }}
          target_group_arn: ${{ steps.alb-setup.outputs.target_group_arn }}
          container_name: ${{ inputs.container_name }}
          container_port: ${{ inputs.container_port }}
          subnet_ids: ${{ inputs.subnet_ids }}
          security_group_ids: ${{ inputs.security_group_ids }}
          assign_public_ip: ${{ inputs.assign_public_ip }}
          desired_count: ${{ inputs.desired_count }}
          enable_zone_rebalancing: ${{ inputs.enable_zone_rebalancing && 'true' || 'false' }}
          health_check_grace_period_seconds: ${{ inputs.health_check_grace_period_seconds }}
          deployment_circuit_breaker_enable: ${{ inputs.deployment_circuit_breaker_enable && 'true' || 'false' }}
          deployment_circuit_breaker_rollback: ${{ inputs.deployment_circuit_breaker_rollback && 'true' || 'false' }}
          capacity_provider_strategy: ${{ inputs.capacity_provider_strategy }}
          platform_version: ${{ inputs.platform_version }}
          enable_execute_command: ${{ inputs.enable_execute_command && 'true' || 'false' }}
          deployment_minimum_healthy_percent: ${{ inputs.deployment_minimum_healthy_percent }}
          deployment_maximum_percent: ${{ inputs.deployment_maximum_percent }}

      # ========== METADATA ==========
      - name: Generate deploy metadata
        if: success()
        run: |
          mkdir -p .deploys
          cat << EOF > .deploys/deploy.json
          {
            "environment": "${{ inputs.environment }}",
            "ecs_service": "${{ inputs.ecs_service }}",
            "image_uri": "${{ inputs.image_uri }}",
            "task_definition_arn": "${{ steps.task-def.outputs.task_definition_arn }}",
            "service_arn": "${{ steps.ecs-deploy.outputs.service_arn }}",
            "commit_sha": "${{ github.sha }}",
            "timestamp": "$(date -u +%Y-%m-%dT%H:%M:%SZ)",
            "run_id": "${{ github.run_id }}"
          }
          EOF

      - name: Upload deploy metadata
        uses: actions/upload-artifact@v4
        if: success()
        with:
          name: deploy-${{ inputs.environment }}-${{ inputs.ecs_service }}-${{ github.run_id }}
          path: .deploys

      # ========== HEALTH CHECK ==========
      - name: Health check
        if: inputs.enable_health_check && inputs.health_check_url != ''
        run: |
          URL="${{ inputs.health_check_url }}"
          for i in $(seq 1 12); do
            curl -sf "$URL" > /dev/null && echo "✅ Health check OK" && exit 0
            echo "Tentativa $i/12 falhou; aguardando 10s..."
            sleep 10
          done
          echo "❌ Health check falhou" && exit 1
