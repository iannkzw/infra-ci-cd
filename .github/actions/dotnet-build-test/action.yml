name: '.NET Build and Test'
description: 'Setup .NET SDK, restore packages, and run tests'

inputs:
  dotnet_version:
    description: 'VersÃ£o do .NET SDK'
    required: false
    default: '8.0'
  working_directory:
    description: 'DiretÃ³rio do cÃ³digo fonte'
    required: false
    default: 'src'
  run_tests:
    description: 'Executar testes unitÃ¡rios'
    required: false
    default: 'true'
  test_filter:
    description: 'Filtro para testes (ex: FullyQualifiedName~UnitTests)'
    required: false
    default: ''
  build_configuration:
    description: 'ConfiguraÃ§Ã£o de build (Debug, Release)'
    required: false
    default: 'Release'

outputs:
  restore_cache_hit:
    description: 'Se o cache de NuGet foi utilizado'
    value: ${{ steps.cache-nuget.outputs.cache-hit }}

runs:
  using: 'composite'
  steps:
    - name: Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: ${{ inputs.dotnet_version }}

    - name: Cache NuGet packages
      id: cache-nuget
      uses: actions/cache@v4
      with:
        path: ~/.nuget/packages
        key: ${{ runner.os }}-nuget-${{ hashFiles(format('{0}/**/*.csproj', inputs.working_directory)) }}
        restore-keys: |
          ${{ runner.os }}-nuget-

    - name: Restore dependencies
      shell: bash
      working-directory: ${{ inputs.working_directory }}
      run: |
        echo "ðŸ”„ Restaurando dependÃªncias .NET..."
        dotnet restore
        echo "âœ… Restore concluÃ­do"

    - name: Build
      shell: bash
      working-directory: ${{ inputs.working_directory }}
      run: |
        echo "ðŸ”¨ Compilando projeto..."
        dotnet build --no-restore --configuration ${{ inputs.build_configuration }}
        echo "âœ… Build concluÃ­do"

    - name: Run tests
      if: inputs.run_tests == 'true'
      shell: bash
      working-directory: ${{ inputs.working_directory }}
      run: |
        echo "ðŸ§ª Executando testes..."
        FILTER_ARG=""
        if [ -n "${{ inputs.test_filter }}" ]; then
          FILTER_ARG="--filter ${{ inputs.test_filter }}"
        fi
        dotnet test --no-build --configuration ${{ inputs.build_configuration }} --verbosity normal $FILTER_ARG
        echo "âœ… Testes concluÃ­dos"
